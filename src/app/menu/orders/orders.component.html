<ng-template #successTpl let-toast>
  <div class="toast-header">
    <strong class="toast-title">Komunikat</strong>
    <button type="button" class="toast-close" (click)="toast.remove()">&times;</button>
  </div>
  <div class="toast-body">
    {{ toastSuccessMessage }}
  </div>
</ng-template>

<div class="layout">
  <!-- Header -->
  <header class="header">
    <div class="header-content">
      <div class="page-title">
        <div class="icon">
          <i class="bx bx-cart"></i>
        </div>
        <h1>Zamówienia</h1>
      </div>
      <div class="header-actions">
        <button mat-raised-button
                class="btn btn-primary"
                (click)="synchronizeOrders(successTpl)"
                [disabled]="isLoading">
          <i class="bx bx-sync" [class.spinning]="isLoading"></i>
          <span *ngIf="!isLoading">Synchronizuj</span>
          <span *ngIf="isLoading">Synchronizowanie...</span>
        </button>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Stats Grid -->
    <section class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon blue">
          <i class="bx bx-shopping-bag"></i>
        </div>
        <div class="stat-number">{{ totalElements }}</div>
        <div class="stat-label">Wszystkie zamówienia</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon orange">
          <i class="bx bx-time"></i>
        </div>
        <div class="stat-number">{{ getOrdersCountByStatus(OrderStatus.PROCESSING) + getOrdersCountByStatus(OrderStatus.READY_FOR_SHIPMENT) }}</div>
        <div class="stat-label">Do realizacji</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon green">
          <i class="bx bx-check-circle"></i>
        </div>
        <div class="stat-number">{{ getOrdersCountByStatus(OrderStatus.SENT) + getOrdersCountByStatus(OrderStatus.PICKED_UP) }}</div>
        <div class="stat-label">Zrealizowane</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon purple">
          <i class="bx bx-receipt"></i>
        </div>
        <div class="stat-number">{{ getOrdersWithInvoicesCount() }}</div>
        <div class="stat-label">Z fakturami</div>
      </div>
    </section>

    <!-- Controls -->
    <section class="controls-section">
      <div class="controls-grid">
        <div class="search-wrapper">
          <i class="bx bx-search search-icon"></i>
          <input
            type="text"
            class="search-input"
            placeholder="Szukaj po numerze zamówienia, nazwisku kupującego..."
            (input)="applyFilter($event)"
          >
        </div>
      </div>

      <div class="filters-row">
        <div class="filter-group">
          <label class="filter-label">Rynek</label>
          <div class="market-filter">
            <div class="market-chip" [class.active]="filterMarket === ''" (click)="filterByMarket('')">
              Wszystkie
            </div>
            <div class="market-chip" [class.active]="filterMarket === 'pl'" (click)="filterByMarket('pl')">
              <div class="market-flag flag-pl"></div>
              Polska
            </div>
            <div class="market-chip" [class.active]="filterMarket === 'cz'" (click)="filterByMarket('cz')">
              <div class="market-flag flag-cz"></div>
              Czechy
            </div>
            <div class="market-chip" [class.active]="filterMarket === 'sk'" (click)="filterByMarket('sk')">
              <div class="market-flag flag-sk"></div>
              Słowacja
            </div>
            <div class="market-chip" [class.active]="filterMarket === 'hu'" (click)="filterByMarket('hu')">
              <div class="market-flag flag-hu"></div>
              Węgry
            </div>
          </div>
        </div>

        <div class="filter-group">
          <label class="filter-label">Status zamówienia</label>
          <select class="filter-select" (change)="filterByStatus($event)">
            <option value="">Wszystkie statusy</option>
            <option [value]="OrderStatus.NEW">{{ getOrderStatusTranslation(OrderStatus.NEW) }}</option>
            <option [value]="OrderStatus.PROCESSING">{{ getOrderStatusTranslation(OrderStatus.PROCESSING) }}</option>
            <option [value]="OrderStatus.READY_FOR_SHIPMENT">{{ getOrderStatusTranslation(OrderStatus.READY_FOR_SHIPMENT) }}</option>
            <option [value]="OrderStatus.SENT">{{ getOrderStatusTranslation(OrderStatus.SENT) }}</option>
            <option [value]="OrderStatus.PICKED_UP">{{ getOrderStatusTranslation(OrderStatus.PICKED_UP) }}</option>
            <option [value]="OrderStatus.CANCELLED">{{ getOrderStatusTranslation(OrderStatus.CANCELLED) }}</option>
            <option [value]="OrderStatus.RETURNED">{{ getOrderStatusTranslation(OrderStatus.RETURNED) }}</option>
          </select>
        </div>

        <div class="filter-group">
          <label class="filter-label">Data od</label>
          <input type="date" class="filter-input" (change)="filterByDateFrom($event)">
        </div>

        <div class="filter-group">
          <label class="filter-label">Data do</label>
          <input type="date" class="filter-input" (change)="filterByDateTo($event)">
        </div>

        <button class="btn btn-outline" (click)="clearFilters()">
          <i class="bx bx-filter-alt"></i>
          Wyczyść
        </button>
      </div>
    </section>

    <!-- Table -->
    <section class="table-section">
      <div class="table-header">
        <span>Wyświetlanie {{ orders.length }} z {{ totalElements }} zamówień</span>
        <div class="page-size-selector">
          <span>Pokaż:</span>
          <select class="page-size-select" [value]="pageSize" (change)="changePageSize($event)">
            <option *ngFor="let size of pageSizeOptions" [value]="size">{{ size }}</option>
          </select>
          <span>pozycji</span>
        </div>
      </div>

      <!-- Loading indicator -->
      <div *ngIf="isLoading" class="loading-container">
        <div class="spinner-large">
          <i class="bx bx-loader-alt spinner"></i>
        </div>
        <p>Ładowanie zamówień...</p>
      </div>

      <!-- Orders Table -->
      <table class="orders-table" *ngIf="!isLoading">
        <thead>
        <tr>
          <th>Kupujący</th>
          <th>Rynek</th>
          <th>Data</th>
          <th>Status</th>
          <th>Wartość</th>
          <th>Faktura</th>
          <th>Allegro</th>
        </tr>
        </thead>
        <tbody>
        <app-order-item
          *ngFor="let order of filteredOrders"
          [order]="order"
          [successTemplate]="successTpl"
          (generateInvoice)="generateInvoice($event, successTpl)"
          (attachToAllegro)="attachInvoiceToAllegro($event.order, $event.invoice, successTpl)">
        </app-order-item>
        </tbody>
      </table>

      <!-- Pagination -->
      <div class="pagination" *ngIf="!isLoading && totalPages > 1">
        <div class="pagination-info">
          Strona {{ currentPage + 1 }} z {{ totalPages }} ({{ totalElements }} pozycji)
        </div>
        <div class="pagination-controls">
          <button
            class="page-btn"
            [disabled]="currentPage === 0"
            (click)="goToFirstPage()"
            title="Pierwsza strona">
            <i class="bx bx-chevron-left"></i>
            <i class="bx bx-chevron-left"></i>
          </button>

          <button
            class="page-btn"
            [disabled]="currentPage === 0"
            (click)="goToPreviousPage()"
            title="Poprzednia strona">
            <i class="bx bx-chevron-left"></i>
          </button>

          <div class="page-numbers">
            <button
              *ngFor="let pageNum of getPageNumbers()"
              class="page-btn"
              [class.active]="pageNum === currentPage"
              (click)="goToPage(pageNum)">
              {{ pageNum + 1 }}
            </button>
          </div>

          <button
            class="page-btn"
            [disabled]="currentPage === totalPages - 1"
            (click)="goToNextPage()"
            title="Następna strona">
            <i class="bx bx-chevron-right"></i>
          </button>

          <button
            class="page-btn"
            [disabled]="currentPage === totalPages - 1"
            (click)="goToLastPage()"
            title="Ostatnia strona">
            <i class="bx bx-chevron-right"></i>
            <i class="bx bx-chevron-right"></i>
          </button>
        </div>
      </div>
    </section>
  </main>
</div>
