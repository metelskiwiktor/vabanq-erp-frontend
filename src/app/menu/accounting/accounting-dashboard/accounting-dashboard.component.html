<div class="dashboard-container">
  <!-- Header -->
  <div class="page-header">
    <div class="page-title">
      <h1>Raport Finansowy</h1>
      <p class="page-subtitle">Analiza przychodów, kosztów i rentowności ofert</p>
    </div>
  </div>

  <!-- Month Navigation -->
  <div class="month-navigation">
    <div class="month-selector">
      <button class="month-nav-btn" (click)="previousMonth()" [disabled]="isLoading">
        <mat-icon>chevron_left</mat-icon>
      </button>
      <div class="current-month">{{ getMonthDisplayName() }}</div>
      <button class="month-nav-btn" (click)="nextMonth()" [disabled]="isLoading">
        <mat-icon>chevron_right</mat-icon>
      </button>
      <button class="current-month-btn" (click)="currentMonth()" [disabled]="isLoading">
        Bieżący miesiąc
      </button>
    </div>
    <button
      class="export-button"
      (click)="exportReport()"
      [disabled]="isLoading || isExporting || !reportData">
      <mat-icon>{{ isExporting ? 'hourglass_empty' : 'download' }}</mat-icon>
      {{ isExporting ? 'Eksportowanie...' : 'Eksportuj raport' }}
    </button>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-state">
    <mat-icon class="loading-icon">hourglass_empty</mat-icon>
    <p>Ładowanie raportu finansowego...</p>
  </div>

  <!-- Report Content -->
  <div *ngIf="!isLoading && reportData" class="report-content">
    <!-- Main Metrics -->
    <div class="metrics-grid">
      <div class="metric-card">
        <div class="metric-header">
          <div class="metric-info">
            <p class="metric-label">Przychód</p>
            <h3 class="metric-value">{{ formatCurrency(reportData.revenue) }}</h3>
          </div>
          <span class="metric-badge positive">
            <mat-icon>trending_up</mat-icon>
          </span>
        </div>
        <div class="metric-footer">
          <p class="metric-comparison">Łączny przychód za miesiąc</p>
        </div>
      </div>

      <div class="metric-card">
        <div class="metric-header">
          <div class="metric-info">
            <p class="metric-label">Zysk brutto</p>
            <h3 class="metric-value" [ngClass]="getProfitStatusClass(reportData.profit)">
              {{ formatCurrency(reportData.profit) }}
            </h3>
          </div>
          <span class="metric-badge" [ngClass]="reportData.profit >= 0 ? 'positive' : 'negative'">
            <mat-icon>{{ reportData.profit >= 0 ? 'trending_up' : 'trending_down' }}</mat-icon>
          </span>
        </div>
        <div class="metric-footer">
          <p class="metric-comparison">Marża: {{ formatPercentage(profitMargin) }}</p>
        </div>
      </div>

      <div class="metric-card">
        <div class="metric-header">
          <div class="metric-info">
            <p class="metric-label">Koszty produkcji</p>
            <h3 class="metric-value">{{ formatCurrency(reportData.productionCost) }}</h3>
          </div>
          <span class="metric-badge warning">
            <mat-icon>build</mat-icon>
          </span>
        </div>
        <div class="metric-footer">
          <p class="metric-comparison">
            % przychodów: {{ formatPercentage(reportData.revenue > 0 ? (reportData.productionCost / reportData.revenue) * 100 : 0) }}
          </p>
        </div>
      </div>

      <div class="metric-card">
        <div class="metric-header">
          <div class="metric-info">
            <p class="metric-label">Wydatki</p>
            <h3 class="metric-value">{{ formatCurrency(reportData.expenses) }}</h3>
          </div>
          <span class="metric-badge warning">
            <mat-icon>receipt_long</mat-icon>
          </span>
        </div>
        <div class="metric-footer">
          <p class="metric-comparison">
            % przychodów: {{ formatPercentage(reportData.revenue > 0 ? (reportData.expenses / reportData.revenue) * 100 : 0) }}
          </p>
        </div>
      </div>
    </div>

    <!-- Charts Section -->
    <div class="charts-section">
      <!-- Cost Breakdown Chart -->
      <div class="chart-card">
        <div class="section-header">
          <h2 class="section-title">Struktura kosztów produkcji</h2>
          <div class="total-cost">
            Razem: {{ formatCurrency(reportData.productionCost) }}
          </div>
        </div>

        <div class="cost-chart" *ngIf="costBreakdown.length > 0; else noCostData">
          <div class="cost-item" *ngFor="let cost of costBreakdown">
            <div class="cost-label">{{ cost.name }}</div>
            <div class="cost-bar-container">
              <div
                class="cost-bar-fill"
                [style.background-color]="cost.color"
                [style.width.%]="getCostPercentage(cost.value)">
              </div>
            </div>
            <div class="cost-value">{{ formatCurrency(cost.value) }}</div>
          </div>
        </div>

        <ng-template #noCostData>
          <div class="no-data-message">
            <mat-icon>info</mat-icon>
            <p>Brak danych o kosztach produkcji</p>
          </div>
        </ng-template>
      </div>

      <!-- Profit Overview -->
      <div class="chart-card">
        <div class="section-header">
          <h2 class="section-title">Rentowność</h2>
        </div>

        <div class="profit-overview">
          <div class="profit-chart">
            <div class="profit-circle" [ngClass]="reportData.profit >= 0 ? 'profitable' : 'unprofitable'">
              <div class="profit-percentage">{{ formatPercentage(profitMargin) }}</div>
              <div class="profit-label">Marża</div>
            </div>
          </div>

          <div class="profit-breakdown">
            <div class="profit-item profit-positive">
              <mat-icon>trending_up</mat-icon>
              <div class="profit-info">
                <div class="profit-name">Przychód</div>
                <div class="profit-amount">{{ formatCurrency(reportData.revenue) }}</div>
              </div>
            </div>

            <div class="profit-item profit-negative">
              <mat-icon>trending_down</mat-icon>
              <div class="profit-info">
                <div class="profit-name">Koszty całkowite</div>
                <div class="profit-amount">{{ formatCurrency(reportData.productionCost + reportData.expenses) }}</div>
              </div>
            </div>

            <div class="profit-item" [ngClass]="getProfitStatusClass(reportData.profit)">
              <mat-icon>account_balance_wallet</mat-icon>
              <div class="profit-info">
                <div class="profit-name">Zysk brutto</div>
                <div class="profit-amount">{{ formatCurrency(reportData.profit) }}</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Offers Profitability Table -->
    <div class="offers-section">
      <div class="section-header">
        <h2 class="section-title">Rentowność ofert</h2>
        <div class="offers-summary">
          <span class="offers-count">{{ reportData.offers.length }} ofert</span>
        </div>
      </div>

      <div class="table-container" *ngIf="reportData.offers.length > 0; else noOffersData">
        <table class="offers-table">
          <thead>
          <tr>
            <th>ID Oferty</th>
            <th>Nazwa oferty</th>
            <th>Produkty</th>
            <th>Sprzedano</th>
            <th>Przychód</th>
            <th>Materiały</th>
            <th>Praca</th>
            <th>Energia</th>
            <th>Opakowania</th>
            <th>Zysk</th>
            <th>Marża</th>
          </tr>
          </thead>
          <tbody>
          <tr *ngFor="let offer of reportData.offers; trackBy: trackByOfferId">
            <td class="offer-id">{{ offer.offerId }}</td>
            <td class="offer-name">{{ offer.offerName }}</td>
            <td class="products-list">
                <span *ngFor="let product of offer.productNames; let last = last">
                  {{ product }}<span *ngIf="!last">, </span>
                </span>
            </td>
            <td class="quantity">{{ offer.quantitySold }} szt.</td>
            <td class="revenue">{{ formatCurrency(offer.revenue) }}</td>
            <td class="cost">{{ formatCurrency(offer.materialCost) }}</td>
            <td class="cost">{{ formatCurrency(offer.laborCost) }}</td>
            <td class="cost">{{ formatCurrency(offer.powerCost) }}</td>
            <td class="cost">{{ formatCurrency(offer.packagingCost) }}</td>
            <td class="profit" [ngClass]="getProfitStatusClass(offer.profit)">
              {{ formatCurrency(offer.profit) }}
            </td>
            <td class="margin" [ngClass]="getProfitStatusClass(offer.profit)">
              {{ formatPercentage(getOfferMargin(offer)) }}
            </td>
          </tr>
          </tbody>
        </table>
      </div>

      <ng-template #noOffersData>
        <div class="no-data-message">
          <mat-icon>shopping_bag</mat-icon>
          <p>Brak danych o sprzedaży ofert w wybranym miesiącu</p>
        </div>
      </ng-template>
    </div>
  </div>

  <!-- No Data State -->
  <div *ngIf="!isLoading && !reportData" class="no-data-state">
    <mat-icon>analytics</mat-icon>
    <h3>Brak danych</h3>
    <p>Nie udało się załadować raportu finansowego dla wybranego miesiąca.</p>
    <button mat-raised-button color="primary" (click)="loadFinancialReport()">
      <mat-icon>refresh</mat-icon>
      Spróbuj ponownie
    </button>
  </div>
</div>
