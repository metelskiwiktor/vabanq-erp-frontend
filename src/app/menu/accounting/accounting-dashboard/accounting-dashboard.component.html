<div class="dashboard-container">
  <!-- Header -->
  <div class="page-header">
    <div class="page-title">
      <h1>Raport Finansowy</h1>
      <p class="page-subtitle">Analiza przychodów, kosztów i rentowności ofert</p>
    </div>
  </div>

  <!-- Controls Bar -->
  <div class="controls-bar">
    <!-- Month Navigation -->
    <div class="month-selector">
      <button class="month-nav-btn" (click)="previousMonth()" [disabled]="isLoading">
        <mat-icon>chevron_left</mat-icon>
      </button>
      <div class="current-month">{{ getMonthDisplayName() }}</div>
      <button class="month-nav-btn" (click)="nextMonth()" [disabled]="isLoading">
        <mat-icon>chevron_right</mat-icon>
      </button>
      <button class="current-month-btn" (click)="currentMonth()" [disabled]="isLoading">
        Bieżący miesiąc
      </button>
    </div>

    <!-- Price Mode Toggle -->
    <div class="price-mode-toggle">
      <button
        class="toggle-button"
        [class.active]="showNetPrices"
        (click)="togglePriceMode()"
        [disabled]="isLoading">
        <mat-icon>{{ showNetPrices ? 'money_off' : 'attach_money' }}</mat-icon>
        {{ showNetPrices ? 'Ceny netto' : 'Ceny brutto' }}
      </button>
    </div>

    <!-- Export Button -->
    <button
      class="export-button"
      (click)="exportReport()"
      [disabled]="isLoading || isExporting || !reportData">
      <mat-icon>{{ isExporting ? 'hourglass_empty' : 'download' }}</mat-icon>
      {{ isExporting ? 'Eksportowanie...' : 'Eksportuj raport' }}
    </button>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-state">
    <mat-icon class="loading-icon">hourglass_empty</mat-icon>
    <p>Ładowanie raportu finansowego...</p>
  </div>

  <!-- Report Content -->
  <div *ngIf="!isLoading && reportData" class="report-content">
    <!-- Main Metrics -->
    <div class="metrics-grid">
      <div class="metric-card">
        <div class="metric-header">
          <div class="metric-info">
            <p class="metric-label">Przychód ({{ getPriceModeLabel() }})</p>
            <h3 class="metric-value">{{ formatCurrency(getPrice(reportData.revenue)) }}</h3>
          </div>
          <span class="metric-badge positive">
            <mat-icon>trending_up</mat-icon>
          </span>
        </div>
        <div class="metric-footer">
          <p class="metric-comparison">Łączny przychód za miesiąc</p>
        </div>
      </div>

      <div class="metric-card">
        <div class="metric-header">
          <div class="metric-info">
            <p class="metric-label">Zysk ({{ getPriceModeLabel() }})</p>
            <h3 class="metric-value" [ngClass]="getProfitStatusClass(getPrice(reportData.profit))">
              {{ formatCurrency(getPrice(reportData.profit)) }}
            </h3>
          </div>
          <span class="metric-badge" [ngClass]="getPrice(reportData.profit) >= 0 ? 'positive' : 'negative'">
            <mat-icon>{{ getPrice(reportData.profit) >= 0 ? 'trending_up' : 'trending_down' }}</mat-icon>
          </span>
        </div>
        <div class="metric-footer">
          <p class="metric-comparison">Marża: {{ formatPercentage(profitMargin) }}</p>
        </div>
      </div>

      <div class="metric-card">
        <div class="metric-header">
          <div class="metric-info">
            <p class="metric-label">Koszty produkcji ({{ getPriceModeLabel() }})</p>
            <h3 class="metric-value">{{ formatCurrency(getPrice(reportData.productionCost)) }}</h3>
          </div>
          <span class="metric-badge warning">
            <mat-icon>build</mat-icon>
          </span>
        </div>
        <div class="metric-footer">
          <p class="metric-comparison">
            % przychodów: {{ formatPercentage(getPrice(reportData.revenue) > 0 ? (getPrice(reportData.productionCost) / getPrice(reportData.revenue)) * 100 : 0) }}
          </p>
        </div>
      </div>

      <div class="metric-card">
        <div class="metric-header">
          <div class="metric-info">
            <p class="metric-label">Wydatki ({{ getPriceModeLabel() }})</p>
            <h3 class="metric-value">{{ formatCurrency(getPrice(reportData.expenses)) }}</h3>
          </div>
          <span class="metric-badge warning">
            <mat-icon>receipt_long</mat-icon>
          </span>
        </div>
        <div class="metric-footer">
          <p class="metric-comparison">
            % przychodów: {{ formatPercentage(getPrice(reportData.revenue) > 0 ? (getPrice(reportData.expenses) / getPrice(reportData.revenue)) * 100 : 0) }}
          </p>
        </div>
      </div>
    </div>

    <!-- Charts Section -->
    <div class="charts-section">
      <!-- Cost Breakdown Chart -->
      <div class="chart-card">
        <div class="section-header">
          <h2 class="section-title">Struktura kosztów produkcji ({{ getPriceModeLabel() }})</h2>
          <div class="total-cost">
            Razem: {{ formatCurrency(getPrice(reportData.productionCost)) }}
          </div>
        </div>

        <div class="cost-chart" *ngIf="costBreakdown.length > 0; else noCostData">
          <div class="cost-item" *ngFor="let cost of costBreakdown">
            <div class="cost-label">{{ cost.name }}</div>
            <div class="cost-bar-container">
              <div
                class="cost-bar-fill"
                [style.background-color]="cost.color"
                [style.width.%]="getCostPercentage(cost.value)">
              </div>
            </div>
            <div class="cost-value">{{ formatCurrency(cost.value) }}</div>
          </div>
        </div>

        <ng-template #noCostData>
          <div class="no-data-message">
            <mat-icon>info</mat-icon>
            <p>Brak danych o kosztach produkcji</p>
          </div>
        </ng-template>
      </div>

      <!-- Profit Overview -->
      <div class="chart-card">
        <div class="section-header">
          <h2 class="section-title">Rentowność ({{ getPriceModeLabel() }})</h2>
        </div>

        <div class="profit-overview">
          <div class="profit-chart">
            <div class="profit-circle" [ngClass]="getPrice(reportData.profit) >= 0 ? 'profitable' : 'unprofitable'">
              <div class="profit-percentage">{{ formatPercentage(profitMargin) }}</div>
              <div class="profit-label">Marża</div>
            </div>
          </div>

          <div class="profit-breakdown">
            <div class="profit-item profit-positive">
              <mat-icon>trending_up</mat-icon>
              <div class="profit-info">
                <div class="profit-name">Przychód</div>
                <div class="profit-amount">{{ formatCurrency(getPrice(reportData.revenue)) }}</div>
              </div>
            </div>

            <div class="profit-item profit-negative">
              <mat-icon>trending_down</mat-icon>
              <div class="profit-info">
                <div class="profit-name">Koszty całkowite</div>
                <div class="profit-amount">{{ formatCurrency(getPrice(reportData.productionCost) + getPrice(reportData.expenses)) }}</div>
              </div>
            </div>

            <div class="profit-item" [ngClass]="getProfitStatusClass(getPrice(reportData.profit))">
              <mat-icon>account_balance_wallet</mat-icon>
              <div class="profit-info">
                <div class="profit-name">Zysk</div>
                <div class="profit-amount">{{ formatCurrency(getPrice(reportData.profit)) }}</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Offers Profitability Table -->
    <div class="offers-section">
      <div class="section-header">
        <h2 class="section-title">Rentowność ofert ({{ getPriceModeLabel() }})</h2>
        <div class="offers-summary">
          <span class="offers-count">{{ totalOffers }} ofert</span>
        </div>
      </div>

      <!-- Offers Search and Filters -->
      <div class="offers-controls">
        <mat-form-field class="search-field" appearance="outline">
          <mat-label>Szukaj ofert...</mat-label>
          <input matInput
                 [(ngModel)]="offerSearchQuery"
                 (ngModelChange)="onOfferSearch()"
                 placeholder="ID oferty, nazwa lub produkt">
          <mat-icon matSuffix>search</mat-icon>
          <button *ngIf="offerSearchQuery"
                  matSuffix
                  mat-icon-button
                  (click)="clearOfferSearch()"
                  class="clear-search-btn">
            <mat-icon>clear</mat-icon>
          </button>
        </mat-form-field>
      </div>

      <!-- Offers Table -->
      <div class="table-container" *ngIf="filteredOffers.length > 0; else noOffersData">
        <table mat-table [dataSource]="paginatedOffers" class="offers-table">
          <!-- ID Column -->
          <ng-container matColumnDef="offerId">
            <th mat-header-cell *matHeaderCellDef>ID Oferty</th>
            <td mat-cell *matCellDef="let offer" class="offer-id">{{ offer.offerId }}</td>
          </ng-container>

          <!-- Name Column -->
          <ng-container matColumnDef="offerName">
            <th mat-header-cell *matHeaderCellDef>Nazwa oferty</th>
            <td mat-cell *matCellDef="let offer" class="offer-name">{{ offer.offerName }}</td>
          </ng-container>

          <!-- Products Column -->
          <ng-container matColumnDef="productNames">
            <th mat-header-cell *matHeaderCellDef>Produkty</th>
            <td mat-cell *matCellDef="let offer" class="products-list">
              <span *ngFor="let product of offer.productNames; let last = last">
                {{ product }}<span *ngIf="!last">, </span>
              </span>
            </td>
          </ng-container>

          <!-- Quantity Column -->
          <ng-container matColumnDef="quantitySold">
            <th mat-header-cell *matHeaderCellDef>Sprzedano</th>
            <td mat-cell *matCellDef="let offer" class="quantity">{{ offer.quantitySold }} szt.</td>
          </ng-container>

          <!-- Price Per Quantity Column -->
          <ng-container matColumnDef="pricePerQuantity">
            <th mat-header-cell *matHeaderCellDef>Cena za sztukę</th>
            <td mat-cell *matCellDef="let offer" class="price">{{ formatCurrency(getPrice(offer.pricePerQuantity)) }}</td>
          </ng-container>

          <!-- Revenue Column -->
          <ng-container matColumnDef="revenue">
            <th mat-header-cell *matHeaderCellDef>Przychód</th>
            <td mat-cell *matCellDef="let offer" class="revenue">{{ formatCurrency(getPrice(offer.revenue)) }}</td>
          </ng-container>

          <!-- Material Cost Column -->
          <ng-container matColumnDef="materialCost">
            <th mat-header-cell *matHeaderCellDef>Materiały</th>
            <td mat-cell *matCellDef="let offer" class="cost">{{ formatCurrency(getPrice(offer.materialCost)) }}</td>
          </ng-container>

          <!-- Labor Cost Column -->
          <ng-container matColumnDef="laborCost">
            <th mat-header-cell *matHeaderCellDef>Praca</th>
            <td mat-cell *matCellDef="let offer" class="cost">{{ formatCurrency(getPrice(offer.laborCost)) }}</td>
          </ng-container>

          <!-- Power Cost Column -->
          <ng-container matColumnDef="powerCost">
            <th mat-header-cell *matHeaderCellDef>Energia</th>
            <td mat-cell *matCellDef="let offer" class="cost">{{ formatCurrency(getPrice(offer.powerCost)) }}</td>
          </ng-container>

          <!-- Packaging Cost Column -->
          <ng-container matColumnDef="packagingCost">
            <th mat-header-cell *matHeaderCellDef>Opakowania</th>
            <td mat-cell *matCellDef="let offer" class="cost">{{ formatCurrency(getPrice(offer.packagingCost)) }}</td>
          </ng-container>

          <!-- Profit Column -->
          <ng-container matColumnDef="profit">
            <th mat-header-cell *matHeaderCellDef>Zysk</th>
            <td mat-cell *matCellDef="let offer" class="profit" [ngClass]="getProfitStatusClass(getPrice(offer.profit))">
              {{ formatCurrency(getPrice(offer.profit)) }}
            </td>
          </ng-container>

          <!-- Margin Column -->
          <ng-container matColumnDef="margin">
            <th mat-header-cell *matHeaderCellDef>Marża</th>
            <td mat-cell *matCellDef="let offer" class="margin" [ngClass]="getProfitStatusClass(getPrice(offer.profit))">
              {{ formatPercentage(getOfferMargin(offer)) }}
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;"
              [class.hover-row]="true"></tr>
        </table>

        <!-- Pagination -->
        <mat-paginator
          [length]="totalOffers"
          [pageSize]="offersPageSize"
          [pageSizeOptions]="[5, 10, 25, 50]"
          [pageIndex]="offersPageIndex"
          (page)="onOffersPageChange($event)"
          showFirstLastButtons>
        </mat-paginator>
      </div>

      <ng-template #noOffersData>
        <div class="no-data-message">
          <mat-icon>shopping_bag</mat-icon>
          <p>{{ offerSearchQuery ? 'Brak ofert pasujących do wyszukiwania' : 'Brak danych o sprzedaży ofert w wybranym miesiącu' }}</p>
          <button *ngIf="offerSearchQuery"
                  mat-button
                  color="primary"
                  (click)="clearOfferSearch()">
            Wyczyść filtr
          </button>
        </div>
      </ng-template>
    </div>
  </div>

  <!-- No Data State -->
  <div *ngIf="!isLoading && !reportData" class="no-data-state">
    <mat-icon>analytics</mat-icon>
    <h3>Brak danych</h3>
    <p>Nie udało się załadować raportu finansowego dla wybranego miesiąca.</p>
    <button mat-raised-button color="primary" (click)="loadFinancialReport()">
      <mat-icon>refresh</mat-icon>
      Spróbuj ponownie
    </button>
  </div>
</div>
