<!-- src/app/menu/accounting/accounting-expenses.component.html -->
<div class="accounting-container">
  <!-- Górny pasek nawigacyjny -->
  <header class="header">
    <div class="header-content">
      <div class="header-left">
        <h1 class="header-title">Panel Zarządzania Kosztami</h1>
      </div>
      <div class="header-right">
        <!-- Month/Year Selector -->
        <div class="date-selector">
          <button mat-icon-button
                  class="date-nav-button"
                  (click)="goToPreviousMonth()"
                  [disabled]="isLoading"
                  matTooltip="Poprzedni miesiąc">
            <mat-icon>chevron_left</mat-icon>
          </button>

          <div class="date-controls">
            <mat-form-field appearance="outline" class="month-select">
              <mat-label>Miesiąc</mat-label>
              <mat-select [(ngModel)]="selectedMonth"
                          (selectionChange)="onMonthYearChange()"
                          [disabled]="isLoading">
                <mat-option *ngFor="let month of months" [value]="month.value">
                  {{ month.name }}
                </mat-option>
              </mat-select>
            </mat-form-field>

            <mat-form-field appearance="outline" class="year-select">
              <mat-label>Rok</mat-label>
              <mat-select [(ngModel)]="selectedYear"
                          (selectionChange)="onMonthYearChange()"
                          [disabled]="isLoading">
                <mat-option *ngFor="let year of years" [value]="year">
                  {{ year }}
                </mat-option>
              </mat-select>
            </mat-form-field>
          </div>

          <button mat-icon-button
                  class="date-nav-button"
                  (click)="goToNextMonth()"
                  [disabled]="isLoading"
                  matTooltip="Następny miesiąc">
            <mat-icon>chevron_right</mat-icon>
          </button>

          <button mat-button
                  class="current-month-button"
                  (click)="goToCurrentMonth()"
                  [disabled]="isLoading"
                  matTooltip="Przejdź do bieżącego miesiąca">
            <mat-icon>today</mat-icon>
            Dziś
          </button>
        </div>

        <div class="current-period">
          <span class="period-label">Wybrany okres:</span>
          <span class="period-value">{{ currentMonth }}</span>
        </div>
      </div>
    </div>
  </header>

  <!-- Loading indicator -->
  <div *ngIf="isLoading" class="loading-container">
    <mat-icon class="loading-spinner">refresh</mat-icon>
    <span>Ładowanie...</span>
  </div>

  <!-- Główna zawartość -->
  <main class="main-content" [class.loading]="isLoading">
    <!-- Główne zakładki -->
    <div class="tab-navigation">
      <button
        class="tab-button"
        [class.active]="activeTab === 'company'"
        (click)="setActiveTab('company')">
        Koszty firmowe
      </button>
      <button
        class="tab-button"
        [class.active]="activeTab === 'products'"
        (click)="setActiveTab('products')">
        Koszty produktowe
      </button>
    </div>

    <!-- Zakładka kosztów firmowych -->
    <div *ngIf="activeTab === 'company'" class="content-card">
      <!-- Podzakładki kosztów stałych/zmiennych -->
      <div class="sub-tab-navigation">
        <button
          class="sub-tab-button"
          [class.active]="activeSubTab === 'fixed'"
          (click)="setActiveSubTab('fixed')">
          Koszty stałe (cykliczne)
        </button>
        <button
          class="sub-tab-button"
          [class.active]="activeSubTab === 'variable'"
          (click)="setActiveSubTab('variable')">
          Koszty zmienne
        </button>
      </div>

      <div class="content-padding">
        <!-- Filtrowanie i wyszukiwanie -->
        <div class="filter-controls">
          <div class="search-container">
            <mat-form-field appearance="outline" class="search-field">
              <mat-label>Szukaj wydatków...</mat-label>
              <input matInput
                     placeholder="Szukaj wydatków..."
                     [(ngModel)]="searchQuery"
                     (input)="onSearchChange($event)"
                     [disabled]="isLoading">
              <mat-icon matSuffix>search</mat-icon>
            </mat-form-field>
          </div>

          <div class="filter-options">
            <mat-checkbox
              [(ngModel)]="showGross"
              (change)="toggleGross()"
              class="gross-checkbox">
              Kwoty brutto
            </mat-checkbox>
          </div>

          <button mat-raised-button
                  color="primary"
                  class="add-button"
                  (click)="addExpense()"
                  [disabled]="isLoading">
            <mat-icon>add</mat-icon>
            Dodaj wydatek
          </button>
        </div>

        <!-- Tabela kosztów stałych -->
        <div *ngIf="activeSubTab === 'fixed'" class="table-container">
          <!-- Empty state -->
          <div *ngIf="fixedExpenses.length === 0 && !isLoading" class="empty-state">
            <mat-icon>receipt_long</mat-icon>
            <h3>Brak wydatków stałych</h3>
            <p>Nie ma jeszcze żadnych wydatków stałych dla {{ currentMonth }}.</p>
            <button mat-raised-button color="primary" (click)="addExpense()">
              <mat-icon>add</mat-icon>
              Dodaj pierwszy wydatek
            </button>
          </div>

          <!-- Data table -->
          <mat-table *ngIf="fixedExpenses.length > 0" [dataSource]="fixedExpenses" class="expenses-table">
            <ng-container matColumnDef="category">
              <mat-header-cell *matHeaderCellDef>Kategoria</mat-header-cell>
              <mat-cell *matCellDef="let expense">
                <span class="category-badge" [attr.data-category]="expense.category">
                  {{ expense.category }}
                </span>
              </mat-cell>
            </ng-container>

            <ng-container matColumnDef="name">
              <mat-header-cell *matHeaderCellDef>Nazwa</mat-header-cell>
              <mat-cell *matCellDef="let expense" class="expense-name">
                <div class="expense-info">
                  <span class="name">{{ expense.name }}</span>
                  <span *ngIf="expense.description" class="description">{{ expense.description }}</span>
                </div>
              </mat-cell>
            </ng-container>

            <ng-container matColumnDef="amount">
              <mat-header-cell *matHeaderCellDef>Kwota {{ showGross ? 'brutto' : 'netto' }}</mat-header-cell>
              <mat-cell *matCellDef="let expense">{{ formatCurrencyFromBackend(expense) }}</mat-cell>
            </ng-container>

            <ng-container matColumnDef="recurring">
              <mat-header-cell *matHeaderCellDef>Cykliczny</mat-header-cell>
              <mat-cell *matCellDef="let expense">
                <mat-icon *ngIf="expense.isRecurring" class="recurring-icon" matTooltip="Wydatek cykliczny">
                  repeat
                </mat-icon>
                <mat-icon *ngIf="!expense.isRecurring" class="one-time-icon" matTooltip="Wydatek jednorazowy">
                  event_note
                </mat-icon>
              </mat-cell>
            </ng-container>

            <ng-container matColumnDef="lastUpdated">
              <mat-header-cell *matHeaderCellDef>Ostatnia aktualizacja</mat-header-cell>
              <mat-cell *matCellDef="let expense">{{ expense.lastUpdated | date:'dd.MM.yyyy' }}</mat-cell>
            </ng-container>

            <ng-container matColumnDef="actions">
              <mat-header-cell *matHeaderCellDef>Akcje</mat-header-cell>
              <mat-cell *matCellDef="let expense">
                <button mat-icon-button
                        color="primary"
                        (click)="editExpense(expense.id)"
                        [disabled]="isLoading"
                        matTooltip="Edytuj">
                  <mat-icon>edit</mat-icon>
                </button>
                <button mat-icon-button
                        color="warn"
                        (click)="deleteExpense(expense.id)"
                        [disabled]="isLoading"
                        matTooltip="Usuń">
                  <mat-icon>delete</mat-icon>
                </button>
              </mat-cell>
            </ng-container>

            <mat-header-row *matHeaderRowDef="['category', 'name', 'amount', 'recurring', 'lastUpdated', 'actions']"></mat-header-row>
            <mat-row *matRowDef="let row; columns: ['category', 'name', 'amount', 'recurring', 'lastUpdated', 'actions']"></mat-row>
          </mat-table>

          <!-- Suma poza tabelą -->
          <div *ngIf="fixedExpenses.length > 0" class="table-summary">
            <div class="summary-row">
              <span class="summary-label">Suma kosztów stałych ({{ currentMonth }}):</span>
              <span class="summary-value">{{ formatCurrency(getFixedExpensesTotal()) }}</span>
            </div>
            <div *ngIf="expenseSummary" class="expense-count">
              <span class="count-label">Liczba wydatków:</span>
              <span class="count-value">{{ expenseSummary.expenseCount }}</span>
            </div>
          </div>
        </div>

        <!-- Tabela kosztów zmiennych (mock data) -->
        <div *ngIf="activeSubTab === 'variable'" class="table-container">
          <div class="coming-soon">
            <mat-icon>construction</mat-icon>
            <h3>Koszty zmienne - w przygotowaniu</h3>
            <p>Funkcjonalność kosztów zmiennych będzie dostępna wkrótce.</p>
          </div>

          <!-- Temporary mock table -->
          <mat-table [dataSource]="variableExpenses" class="expenses-table mock-table">
            <ng-container matColumnDef="category">
              <mat-header-cell *matHeaderCellDef>Kategoria</mat-header-cell>
              <mat-cell *matCellDef="let expense">{{ expense.category }}</mat-cell>
            </ng-container>

            <ng-container matColumnDef="name">
              <mat-header-cell *matHeaderCellDef>Nazwa</mat-header-cell>
              <mat-cell *matCellDef="let expense" class="expense-name">{{ expense.name }}</mat-cell>
            </ng-container>

            <ng-container matColumnDef="amount">
              <mat-header-cell *matHeaderCellDef>Kwota {{ showGross ? 'brutto' : 'netto' }}</mat-header-cell>
              <mat-cell *matCellDef="let expense">{{ formatCurrency(expense.amount) }}</mat-cell>
            </ng-container>

            <ng-container matColumnDef="date">
              <mat-header-cell *matHeaderCellDef>Data</mat-header-cell>
              <mat-cell *matCellDef="let expense">{{ expense.date }}</mat-cell>
            </ng-container>

            <ng-container matColumnDef="supplier">
              <mat-header-cell *matHeaderCellDef>Dostawca</mat-header-cell>
              <mat-cell *matCellDef="let expense">{{ expense.supplier }}</mat-cell>
            </ng-container>

            <ng-container matColumnDef="actions">
              <mat-header-cell *matHeaderCellDef>Akcje</mat-header-cell>
              <mat-cell *matCellDef="let expense">
                <button mat-icon-button
                        color="primary"
                        disabled
                        matTooltip="Niedostępne">
                  <mat-icon>edit</mat-icon>
                </button>
                <button mat-icon-button
                        color="warn"
                        disabled
                        matTooltip="Niedostępne">
                  <mat-icon>delete</mat-icon>
                </button>
              </mat-cell>
            </ng-container>

            <mat-header-row *matHeaderRowDef="['category', 'name', 'amount', 'date', 'supplier', 'actions']"></mat-header-row>
            <mat-row *matRowDef="let row; columns: ['category', 'name', 'amount', 'date', 'supplier', 'actions']"></mat-row>
          </mat-table>

          <!-- Suma poza tabelą -->
          <div class="table-summary">
            <div class="summary-row">
              <span class="summary-label">Suma kosztów zmiennych (dane testowe):</span>
              <span class="summary-value">{{ formatCurrency(getVariableExpensesTotal()) }}</span>
            </div>
          </div>
        </div>

        <!-- Podsumowanie miesięczne -->
        <div *ngIf="expenseSummary" class="summary-section">
          <h3 class="summary-title">Podsumowanie kosztów ({{ currentMonth }})</h3>
          <div class="summary-cards">
            <mat-card class="summary-card fixed-costs">
              <mat-card-header>
                <mat-card-title>Koszty stałe</mat-card-title>
              </mat-card-header>
              <mat-card-content>
                <div class="summary-amount">{{ formatCurrency(getFixedExpensesTotal()) }}</div>
                <div class="summary-details">
                  <span>{{ expenseSummary.expenseCount }} wydatków</span>
                </div>
              </mat-card-content>
            </mat-card>

            <mat-card class="summary-card variable-costs">
              <mat-card-header>
                <mat-card-title>Koszty zmienne</mat-card-title>
              </mat-card-header>
              <mat-card-content>
                <div class="summary-amount">{{ formatCurrency(getVariableExpensesTotal()) }}</div>
                <div class="summary-details">
                  <span>{{ variableExpenses.length }} wydatków (testowe)</span>
                </div>
              </mat-card-content>
            </mat-card>

            <mat-card class="summary-card total-costs">
              <mat-card-header>
                <mat-card-title>Suma</mat-card-title>
              </mat-card-header>
              <mat-card-content>
                <div class="summary-amount">{{ formatCurrency(getTotalExpenses()) }}</div>
                <div class="summary-details">
                  <span>{{ expenseSummary.expenseCount + variableExpenses.length }} wydatków łącznie</span>
                </div>
              </mat-card-content>
            </mat-card>
          </div>

          <!-- Category breakdown -->
          <div *ngIf="expenseSummary.categorySummaries.length > 0" class="category-breakdown">
            <h4>Podział na kategorie (koszty stałe)</h4>
            <div class="category-grid">
              <div *ngFor="let category of expenseSummary.categorySummaries" class="category-item">
                <span class="category-name">{{ category.category }}</span>
                <span class="category-amount">
                  {{ showGross ? formatCurrency(category.grossAmount) : formatCurrency(category.netAmount) }}
                </span>
                <span class="category-count">({{ category.count }} wydatków)</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Zakładka kosztów produktowych -->
    <div *ngIf="activeTab === 'products'" class="content-card">
      <!-- Podzakładki -->
      <div class="sub-tab-navigation">
        <button
          class="sub-tab-button"
          [class.active]="productSubTab === 'products'"
          (click)="setProductSubTab('products')">
          Produkty
        </button>
        <button
          class="sub-tab-button"
          [class.active]="productSubTab === 'offers'"
          (click)="setProductSubTab('offers')">
          Oferty (zestawy)
        </button>
      </div>

      <div class="content-padding">
        <!-- Filtrowanie i wyszukiwanie -->
        <div class="filter-controls">
          <div class="search-container">
            <mat-form-field appearance="outline" class="search-field">
              <mat-label>{{ productSubTab === 'products' ? 'Szukaj po nazwie produktu lub EAN...' : 'Szukaj zestawów...' }}</mat-label>
              <input matInput
                     [placeholder]="productSubTab === 'products' ? 'Szukaj po nazwie produktu lub EAN...' : 'Szukaj zestawów...'"
                     [(ngModel)]="searchQuery"
                     (input)="onSearchChange($event)">
              <mat-icon matSuffix>search</mat-icon>
            </mat-form-field>
          </div>

          <div class="filter-options">
            <mat-checkbox
              [(ngModel)]="showGross"
              (change)="toggleGross()"
              class="gross-checkbox">
              Kwoty brutto
            </mat-checkbox>
          </div>
        </div>

        <!-- Tabela produktów -->
        <div *ngIf="productSubTab === 'products'" class="table-container">
          <mat-table [dataSource]="products" class="products-table">
            <ng-container matColumnDef="name">
              <mat-header-cell *matHeaderCellDef>Produkt</mat-header-cell>
              <mat-cell *matCellDef="let product" class="product-name">{{ product.name }}</mat-cell>
            </ng-container>

            <ng-container matColumnDef="ean">
              <mat-header-cell *matHeaderCellDef>EAN</mat-header-cell>
              <mat-cell *matCellDef="let product">{{ product.ean }}</mat-cell>
            </ng-container>

            <ng-container matColumnDef="materialCost">
              <mat-header-cell *matHeaderCellDef>Materiały</mat-header-cell>
              <mat-cell *matCellDef="let product">{{ formatCurrency(product.materialCost) }}</mat-cell>
            </ng-container>

            <ng-container matColumnDef="powerCost">
              <mat-header-cell *matHeaderCellDef>Prąd</mat-header-cell>
              <mat-cell *matCellDef="let product">{{ formatCurrency(product.powerCost) }}</mat-cell>
            </ng-container>

            <ng-container matColumnDef="packagingCost">
              <mat-header-cell *matHeaderCellDef>Opakowanie</mat-header-cell>
              <mat-cell *matCellDef="let product">{{ formatCurrency(product.packagingCost) }}</mat-cell>
            </ng-container>

            <ng-container matColumnDef="laborCost">
              <mat-header-cell *matHeaderCellDef>Robocizna</mat-header-cell>
              <mat-cell *matCellDef="let product">{{ formatCurrency(product.laborCost) }}</mat-cell>
            </ng-container>

            <ng-container matColumnDef="totalCost">
              <mat-header-cell *matHeaderCellDef>Suma kosztów</mat-header-cell>
              <mat-cell *matCellDef="let product" class="total-cost">{{ formatCurrency(product.totalCost) }}</mat-cell>
            </ng-container>

            <ng-container matColumnDef="retailPrice">
              <mat-header-cell *matHeaderCellDef>Cena sprzedaży</mat-header-cell>
              <mat-cell *matCellDef="let product" class="retail-price">{{ formatCurrency(product.retailPrice) }}</mat-cell>
            </ng-container>

            <ng-container matColumnDef="margin">
              <mat-header-cell *matHeaderCellDef>Marża</mat-header-cell>
              <mat-cell *matCellDef="let product">
                <span class="margin-badge" [ngClass]="getMarginClass(product.margin)">
                  {{ product.margin.toFixed(2) }}%
                </span>
              </mat-cell>
            </ng-container>

            <mat-header-row *matHeaderRowDef="['name', 'ean', 'materialCost', 'powerCost', 'packagingCost', 'laborCost', 'totalCost', 'retailPrice', 'margin']"></mat-header-row>
            <mat-row *matRowDef="let row; columns: ['name', 'ean', 'materialCost', 'powerCost', 'packagingCost', 'laborCost', 'totalCost', 'retailPrice', 'margin']"></mat-row>
          </mat-table>
        </div>

        <!-- Tabela ofert (zestawów) -->
        <div *ngIf="productSubTab === 'offers'" class="table-container">
          <mat-table [dataSource]="offers" class="offers-table">
            <ng-container matColumnDef="name">
              <mat-header-cell *matHeaderCellDef>Nazwa zestawu</mat-header-cell>
              <mat-cell *matCellDef="let offer" class="offer-name">{{ offer.name }}</mat-cell>
            </ng-container>

            <ng-container matColumnDef="productsIncluded">
              <mat-header-cell *matHeaderCellDef>Produkty w zestawie</mat-header-cell>
              <mat-cell *matCellDef="let offer" class="products-included">{{ offer.productsIncluded }}</mat-cell>
            </ng-container>

            <ng-container matColumnDef="totalCost">
              <mat-header-cell *matHeaderCellDef>Koszt całkowity</mat-header-cell>
              <mat-cell *matCellDef="let offer">{{ formatCurrency(offer.totalCost) }}</mat-cell>
            </ng-container>

            <ng-container matColumnDef="offerPrice">
              <mat-header-cell *matHeaderCellDef>Cena zestawu</mat-header-cell>
              <mat-cell *matCellDef="let offer" class="offer-price">{{ formatCurrency(offer.offerPrice) }}</mat-cell>
            </ng-container>

            <ng-container matColumnDef="margin">
              <mat-header-cell *matHeaderCellDef>Marża</mat-header-cell>
              <mat-cell *matCellDef="let offer">
                <span class="margin-badge" [ngClass]="getMarginClass(offer.margin)">
                  {{ offer.margin.toFixed(2) }}%
                </span>
              </mat-cell>
            </ng-container>

            <mat-header-row *matHeaderRowDef="['name', 'productsIncluded', 'totalCost', 'offerPrice', 'margin']"></mat-header-row>
            <mat-row *matRowDef="let row; columns: ['name', 'productsIncluded', 'totalCost', 'offerPrice', 'margin']"></mat-row>
          </mat-table>
        </div>
      </div>
    </div>
  </main>
</div>
